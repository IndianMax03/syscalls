# Лабораторная работа №2 по дисциплине "Операционные системы"

## Техническое задание

Разработать комплекс программ на пользовательском уровне и уровне ярда, который собирает информацию на стороне ядра и передает информацию на уровень пользователя, и выводит ее в удобном для чтения человеком виде. Программа на уровне пользователя получает на вход аргумент(ы) командной строки (не адрес!), позволяющие идентифицировать из системных таблиц необходимый путь до целевой структуры, осуществляет передачу на уровень ядра, получает информацию из данной структуры и распечатывает структуру в стандартный вывод. Загружаемый модуль ядра принимает запрос через указанный в задании интерфейс, определяет путь до целевой структуры по переданному запросу и возвращает результат на уровень пользователя.

Интерфейс передачи между программой пользователя и ядром и целевая структура задается преподавателем. Интерфейс передачи может быть один из следующих:

1. **syscall - интерфейс системных вызовов.**
    - syscall: thread_struct, vm_area_struct
1. ioctl - передача параметров через управляющий вызов к файлу/устройству.
1. procfs - файловая система /proc, передача параметров через запись в файл.
1. debugfs - отладочная файловая система /sys/kernel/debug, передача параметров через запись в файл.

Целевая структура может быть задана двумя способами:

1. Именем структуры в заголовочных файлах Linux
1. Файлом в каталоге /proc. В этом случае необходимо определить целевую структуру по пути файла в /proc и выводимым данным.

## Предыстория

> Поскольку, вся информация о структуре потока [была перенесена](https://elixir.bootlin.com/linux/v6.2.1/source/arch/alpha/include/asm/processor.h#L30) из `thread_struct` в `thread_info`, я общался с `thread_info`

Копался я, значит в сорцах ядрышка, искал структуры по варианту, вроде нашел:

- [thread_info](https://elixir.bootlin.com/linux/v6.2.1/source/arch/alpha/include/asm/thread_info.h#L15)
- [vm_area_struct](https://elixir.bootlin.com/linux/v6.2.1/source/include/linux/mm_types.h#L535)

И всё бы ничего, если бы в какой-то момент при сборке ядра я не увидел следующую ошибку:

```console
error: 'struct thread_info' has no member named 'pcb'
```

Я очень смутился , ведь вроде как pcb есть внутри thread_info...

И тут я решил пойти на [крайние меры](https://stackoverflow.com/questions/77470666/error-while-programming-a-custom-system-call-in-the-linux-kernel-version-6-2-1)...

Отвечающий явно дал понять, что я забрел не в ту структуру. Структура для моей платформы находится тут:

- [thread_info](https://elixir.bootlin.com/linux/latest/source/arch/x86/include/asm/thread_info.h#L56)

К тому моменту моё ядро уже было собрано и я уже тестировал свой системный вызов, однако, я получал следующую ошибку:

```console
Fatal glibc error: malloc.c:2593 (sysmalloc): assertion failed: (old_top == initial_top (av) && old_size == 0) || ((unsigned long) (old_size) >= MINSIZE && prev_inuse (old_top) && ((unsigned long) old_end & (pagesize - 1)) == 0)
Аварийный останов (образ памяти сброшен на диск)
```

"Что же это может быть?" - подумал я.

"Выглядит как повреждение кучи. Скорее всего вызванное записями за пределами буфера..." - сказал мой коллега

Немного пораскинув мозгами, я понял, что моя структура для thread_info пытается кастить long до int'а

Я [исправил](https://github.com/IndianMax03/syscalls/commit/57570ad561ff44884739d62cfe358f066ae1ecf7) определение структуры и все заработало!

## Реализация

Реализация системных вызовов доступна тут:

- [Реализация системного вызова к thread_info](/src/t_info/thread_information/thread_information.c)
- [Реализация системного вызова к vm_area_struct](/src/vm_area/vm_area_information/vm_area_information.c)

Процесс добавления системного вызова в ядро описан в [гайде](/guide/README.MD).

## Тестирование

Исходный код тесткейсов для системных вызовов доступен тут:

- [Код для тестирования системного вызова к thread_info](/src/t_info/userspace/t_info_user.c)
- [Код для тестирования системного вызова к vm_area_struct](/src/vm_area/userspace/vma_info_user.c)

Результаты тестирования доступны тут:

- [Результаты тестирования системного вызова к thread_info](/src/t_info/userspace/README.MD)
- [Результаты тестирования системного вызова к vm_area_struct](/src/vm_area/userspace/README.MD)

## Автор

> Тучков Максим Русланович

## Преподаватель практики

> Осипов Святослав Владимирович

## Лектор

> Клименков Сергей Викторович
